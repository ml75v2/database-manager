<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB Manager - SQL</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div style="padding: 1.5rem; border-bottom: 1px solid var(--border);">
                <div class="flex items-center gap-2">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                        <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                        <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                    </svg>
                    <span class="text-xl" style="font-size: 1.25rem;">DB Manager</span>
                </div>
            </div>
            <nav style="padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
                <a href="dashboard.html" class="nav-link">Overview</a>
                <a href="tables.html" class="nav-link">Tables</a>
                <a href="sql.html" class="nav-link active">SQL Playground</a>
            </nav>
            <div style="margin-top: auto; padding: 1rem; border-top: 1px solid var(--border);">
                <a href="index.html" class="nav-link" style="color: var(--danger);">Disconnect</a>
            </div>
        </aside>

        <main class="main-content">
            <h1 class="text-xl mb-4">SQL Playground</h1>

            <!-- Tabs -->
            <div style="margin-bottom: 1rem; border-bottom: 1px solid var(--border); display: flex; gap: 1rem;">
                <button class="btn" style="background: none; border-bottom: 2px solid var(--primary); border-radius: 0;"
                    id="tabDDL" onclick="switchTab('DDL')">DDL (Definition)</button>
                <button class="btn" style="background: none; color: var(--text-muted);" id="tabDML"
                    onclick="switchTab('DML')">DML (Manipulation)</button>
                <button class="btn" style="background: none; color: var(--text-muted);" id="tabDQL"
                    onclick="switchTab('DQL')">DQL (Query)</button>
            </div>

            <!-- DDL Tab -->
            <div id="contentDDL" class="tab-content" style="display: block;">
                <p class="text-muted text-sm mb-2">Create, Alter, Drop tables. Example:
                    <code>CREATE TABLE tests (id INT PRIMARY KEY)</code>
                </p>
                <div class="card" style="padding: 0;">
                    <textarea id="inputDDL" class="sql-area" placeholder="ENTER DDL SQL..."></textarea>
                    <div class="action-bar">
                        <button class="btn" onclick="runQuery('DDL')">Execute DDL</button>
                    </div>
                    <div id="outputDDL" class="output-area"></div>
                </div>
            </div>

            <!-- DML Tab -->
            <div id="contentDML" class="tab-content" style="display: none;">
                <p class="text-muted text-sm mb-2">Insert, Update, Delete data. Example:
                    <code>INSERT INTO users (name) VALUES ('John')</code>
                </p>
                <div class="card" style="padding: 0;">
                    <textarea id="inputDML" class="sql-area" placeholder="ENTER DML SQL..."></textarea>
                    <div class="action-bar">
                        <button class="btn" onclick="runQuery('DML')">Execute DML</button>
                    </div>
                    <div id="outputDML" class="output-area"></div>
                </div>
            </div>

            <!-- DQL Tab -->
            <div id="contentDQL" class="tab-content" style="display: none;">
                <p class="text-muted text-sm mb-2">Select data. Example: <code>SELECT * FROM users</code></p>
                <div class="card" style="padding: 0;">
                    <textarea id="inputDQL" class="sql-area" placeholder="ENTER DQL SQL..."></textarea>
                    <div class="action-bar">
                        <button class="btn" onclick="runQuery('DQL')">Execute DQL</button>
                    </div>
                    <div id="outputDQL" class="output-area"></div>
                </div>
            </div>

        </main>
    </div>

    <style>
        .sql-area {
            background: var(--bg-dark);
            color: #e2e8f0;
            border: none;
            padding: 1rem;
            font-family: monospace;
            resize: none;
            outline: none;
            height: 150px;
            font-size: 14px;
            width: 100%;
            display: block;
        }

        .action-bar {
            padding: 1rem;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
        }

        .output-area {
            background: #020617;
            padding: 1rem;
            border-top: 1px solid var(--border);
            min-height: 100px;
            max-height: 400px;
            overflow: auto;
        }

        .output-area:empty::before {
            content: 'Results will appear here...';
            color: #64748b;
            font-size: 0.875rem;
        }
    </style>

    <script src="js/app.js"></script>
    <script>
        function switchTab(tab) {
            // Reset styles
            ['DDL', 'DML', 'DQL'].forEach(t => {
                document.getElementById('tab' + t).style.borderBottom = 'none';
                document.getElementById('tab' + t).style.color = 'var(--text-muted)';
                document.getElementById('content' + t).style.display = 'none';
            });

            // Activate current
            document.getElementById('tab' + tab).style.borderBottom = '2px solid var(--primary)';
            document.getElementById('tab' + tab).style.color = 'white';
            document.getElementById('content' + tab).style.display = 'block';
        }

        async function runQuery(type) {
            const inputId = 'input' + type;
            const outputId = 'output' + type;
            const sql = document.getElementById(inputId).value;
            const out = document.getElementById(outputId);

            if (!sql.trim()) return;

            out.innerHTML = '<div class="text-muted">Executing...</div>';

            const res = await apiCall('api/query.php', 'POST', { sql });

            if (res && res.ok) {
                if (res.data.success) {
                    if (type === 'DQL') {
                        // Table View
                        if (res.data.data && res.data.data.length > 0) {
                            const cols = res.data.fields || Object.keys(res.data.data[0]);
                            const html = `
                                <div style="margin-bottom: 0.5rem; color: var(--success); font-size: 0.875rem;">${res.data.message}</div>
                                <table>
                                    <thead><tr>${cols.map(c => `<th>${c}</th>`).join('')}</tr></thead>
                                    <tbody>
                                        ${res.data.data.map(r => `
                                            <tr>${cols.map(c => `<td>${escapeHtml(r[c])}</td>`).join('')}</tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `;
                            out.innerHTML = html;
                        } else {
                            out.innerHTML = `<div style="color: var(--success);">Query successful. 0 rows returned.</div>`;
                        }
                    } else {
                        // Message View (DDL/DML)
                        out.innerHTML = `
                            <div style="padding: 1rem; background: rgba(16, 185, 129, 0.1); color: var(--success); border-radius: 0.5rem;">
                                Success! ${res.data.message}
                            </div>
                        `;
                    }
                } else {
                    out.innerHTML = `
                        <div style="padding: 1rem; background: rgba(239, 68, 68, 0.1); color: var(--danger); border-radius: 0.5rem;">
                              Error: ${res.data.error || 'Unknown error'}
                        </div>
                    `;
                }
            } else {
                const errorMsg = res && res.data && res.data.error ? res.data.error : 'Request Failed';
                out.innerHTML = `
                    <div style="padding: 1rem; background: rgba(239, 68, 68, 0.1); color: var(--danger); border-radius: 0.5rem;">
                         Error: ${escapeHtml(errorMsg)}
                    </div>
                `;
            }
        }
    </script>
</body>

</html>