<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB Manager - Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Reusing Chart.js via CDN for the graph as requested "Vanilla JS" approach usually implies libraries via CDN or custom. Chart.js is standard. -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div style="padding: 1.5rem; border-bottom: 1px solid var(--border);">
                <div class="flex items-center gap-2">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                        <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                        <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                    </svg>
                    <span class="text-xl" style="font-size: 1.25rem;">DB Manager</span>
                </div>
            </div>
            <nav style="padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
                <a href="dashboard.html" class="nav-link active">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Overview
                </a>
                <a href="tables.html" class="nav-link">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18">
                        </path>
                    </svg>
                    Tables
                </a>
                <a href="sql.html" class="nav-link">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="4 17 10 11 4 5"></polyline>
                        <line x1="12" y1="19" x2="20" y2="19"></line>
                    </svg>
                    SQL Playground
                </a>
            </nav>
            <div style="margin-top: auto; padding: 1rem; border-top: 1px solid var(--border);">
                <a href="index.html" class="nav-link" style="color: var(--danger);">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    Disconnect
                </a>
            </div>
        </aside>

        <main class="main-content">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl">Dashboard</h1>
                <button id="seedBtn" class="btn"
                    style="background-color: var(--bg-card); border: 1px solid var(--border);">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="margin-right: 0.5rem">
                        <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                        <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                    </svg>
                    Generate Sample Data
                </button>
            </div>

            <div id="statsGrid" class="grid-4 mb-4">
                <!-- KPI Cards injected here -->
                <div class="card">
                    <p class="text-muted">Loading...</p>
                </div>
            </div>

            <div class="card">
                <h3 class="text-xl mb-4" style="font-size: 1.1rem;">Largest Tables</h3>
                <div style="height: 300px;">
                    <canvas id="sizeChart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <script src="js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Seed Button Logic
            document.getElementById('seedBtn').addEventListener('click', async function () {
                if (!confirm('This will create users, products, and orders tables with sample data. Continue?')) return;

                this.disabled = true;
                this.textContent = 'Generating...';

                const res = await apiCall('api/setup_data.php');
                if (res && res.ok && res.data.success) {
                    alert('Sample data created!');
                    window.location.reload();
                } else {
                    alert('Error: ' + (res.data?.error || 'Failed to seed data'));
                    this.textContent = 'Generate Sample Data';
                    this.disabled = false;
                }
            });

            const res = await apiCall('api/stats.php');
            if (res && res.ok) {
                const data = res.data;
                const grid = document.getElementById('statsGrid');

                const stats = [
                    { label: 'Total Tables', value: data.tables, icon: 'text-blue' },
                    { label: 'Total Size', value: formatBytes(data.totalSize), icon: 'text-green' },
                    { label: 'Avg Table Size', value: formatBytes(data.avgSize), icon: 'text-teal' },
                    { label: 'Indexes', value: data.indexes, icon: 'text-purple' },
                    { label: 'Primary Keys', value: data.primaryKeys, icon: 'text-indigo' },
                    { label: 'Foreign Keys', value: data.foreignKeys, icon: 'text-orange' },
                ];

                // Add Users Card separate or in stats? Let's add a list for users
                // Main stats grid
                grid.innerHTML = stats.map(s => `
                    <div class="card">
                        <p class="text-muted text-sm">${s.label}</p>
                        <h3 class="text-xl mt-4">${s.value}</h3>
                    </div>
                `).join('');

                // Append Users list if exists
                if (data.users && data.users.length > 0) {
                    const userCard = document.createElement('div');
                    userCard.className = 'card';
                    userCard.style.gridColumn = 'span 4'; // Full width
                    userCard.innerHTML = `
                        <p class="text-muted text-sm">Database Users</p>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
                            ${data.users.map(u => `<span style="background: var(--bg-dark); padding: 0.25rem 0.75rem; border-radius: 99px; font-size: 0.875rem;">${u}</span>`).join('')}
                        </div>
                     `;
                    grid.appendChild(userCard);
                }

                // Chart
                const ctx = document.getElementById('sizeChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.chartData.map(d => d.name),
                        datasets: [{
                            label: 'Size (Bytes)',
                            data: data.chartData.map(d => d.size),
                            backgroundColor: '#3b82f6',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                grid: { color: '#334155' },
                                ticks: { color: '#94a3b8' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#94a3b8' }
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>

</html>